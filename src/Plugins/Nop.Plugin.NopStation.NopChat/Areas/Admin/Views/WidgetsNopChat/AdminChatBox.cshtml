@model NopChatMessageModel
@{
    Layout = "_AdminLayout";
    Html.AppendCssFileParts($"~/lib_npm/overlayscrollbars/css/OverlayScrollbars.min.css");
    Html.AppendScriptParts(ResourceLocation.Footer, "~/lib_npm/overlayscrollbars/js/jquery.overlayScrollbars.min.js");
}

<style>
    .nop-chat-wrapper {
        text-align: right;
    }

    .nop-chat {
        /*display: inline-block;*/
        /* position: absolute;
        right: 0;
        bottom: 0;
        width: 750px;*/
        background: #FFFFFF;
        /*box-shadow: 0px 4px 50px rgba(150, 162, 171, 0.55);
        border-radius: 10px;*/
        text-align: left;
        padding: 10px;
    }


        .nop-chat .title {
            background: #F1F3F4;
            /*border-radius: 10px 10px 0px 0px;*/
            padding: 10px 15px;
        }

        .nop-chat .chat-logo {
            display: inline-block;
            width: 50%;
        }

        .nop-chat .buttons {
            display: inline-block;
            width: 50%;
            text-align: right;
            margin: 5px 0;
            vertical-align: top;
        }

            .nop-chat .buttons button {
                height: 25px;
                width: 25px;
                align-items: center;
                text-align: center;
                border: 1.5px solid #130F26;
                border-radius: 8px;
                margin-left: 5px;
                background: #F1F3F4;
                color: #130F26;
            }


        .nop-chat .chat-body {
            height: 500px;
        }

        .nop-chat .contact-list {
            display: inline-block;
            width: 40%;
            border-right: 2px solid #E5E5E5;
            vertical-align: top;
            height: 100%;
        }

            .nop-chat .contact-list .contact {
                box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.1);
                border-bottom: 1px solid #E5E5E5;
                padding: 5px 10px;
            }

                .nop-chat .contact-list .contact.unread {
                    background: #F5F5F5 url('/Plugins/NopStation.NopChat/Contents/Images/message-icon.png') 95% no-repeat;
                }

            .nop-chat .contact-list .contact-picture {
                display: inline-block;
                width: 15%;
                padding: 10px;
            }

                .nop-chat .contact-list .contact-picture .picture,
                .nop-chat .chat-box .message-picture .picture {
                    border-radius: 100%;
                    overflow: hidden;
                    position: relative;
                }

                    .nop-chat .contact-list .contact-picture .picture:before,
                    .nop-chat .chat-box .message-picture .picture:before {
                        content: "";
                        display: block;
                        padding-top: 100%;
                    }

                    .nop-chat .contact-list .contact-picture .picture img,
                    .nop-chat .chat-box .message-picture .picture img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        position: absolute;
                        top: 0;
                        left: 0;
                    }

            .nop-chat .contact-list .contact-body {
                display: inline-block;
                width: 60%;
                vertical-align: top;
                font-style: normal;
                font-size: 15px;
                line-height: 18px;
                text-transform: capitalize;
                color: #83898C;
                margin-top: 15px;
            }

                .nop-chat .contact-list .contact-body .name {
                    font-weight: bold;
                }

            .nop-chat .contact-list .contact.unread .contact-body .name {
                color: #00A0DB;
            }

            .nop-chat .contact-list .contact-body .message-preview {
                height: 20px;
                overflow: hidden;
            }

        .nop-chat .chat-box {
            display: inline-block;
            width: 60%;
            height: 100%;
        }

            .nop-chat .chat-box .messages {
                height: 85%;
            }

                .nop-chat .chat-box .messages .message {
                    width: 83%;
                    float: left;
                }

                    .nop-chat .chat-box .messages .message.self {
                        margin: 0 0 0 auto;
                        float: right;
                    }

            .nop-chat .chat-box .message-picture {
                display: inline-block;
                width: 15%;
                padding: 15px;
            }

            .nop-chat .chat-box .messages .message.self .message-picture {
                float: right;
            }

            .nop-chat .chat-box .message-content {
                display: inline-block;
                max-width: 80%;
                vertical-align: top;
                margin-top: 15px;
            }

            .nop-chat .chat-box .messages .message.self .message-content {
                float: right;
            }


            .nop-chat .chat-box .message-content .text {
                padding: 15px;
                background: #39BFF0;
                color: #FFF;
                box-shadow: 0px 4px 10px rgba(78, 204, 251, 0.25);
                border-radius: 0px 5px 5px 20px;
                margin-bottom: 10px;
            }

            .nop-chat .chat-box .messages .message.self .message-content {
                text-align: right;
            }

                .nop-chat .chat-box .messages .message.self .message-content .text {
                    background: #162356;
                    box-shadow: 0px 4px 10px rgba(22, 35, 86, 0.2);
                    border-radius: 5px 0 5px 20px;
                }

            .nop-chat .chat-box .message-content .time-stamp {
                font-style: normal;
                font-weight: normal;
                font-size: 13px;
                line-height: 16px;
                letter-spacing: 0.03em;
                text-transform: lowercase;
                color: #A8A9B4;
            }

            .nop-chat .chat-box .text-box {
                height: 15%;
                width: 100%;
                background: #F5F5F5;
                border-radius: 0px 0px 10px 0px;
            }

                .nop-chat .chat-box .text-box input {
                    width: 75%;
                    display: inline-block;
                    height: 100%;
                    background: #F5F5F5;
                    border: none;
                }

                .nop-chat .chat-box .text-box .send-button {
                    width: 25%;
                    display: inline-block;
                    text-align: center;
                }

                    .nop-chat .chat-box .text-box .send-button button {
                        background: #4ECCFB;
                        box-shadow: 0px 4px 10px rgba(78, 204, 251, 0.25);
                        border-radius: 5px;
                        min-width: 75px;
                        height: 35px;
                        border: none;
                        color: #FFF;
                    }

    /*.nop-chat-wrapper .open-chat {*/
    /*display: inline-block;*/
    /*width: 100px;
        text-align: right;*/
    /*margin-right:100px;*/
    /*position: absolute;
        bottom: 40px;
        right: 40px;*/
    /*z-index:50;*/
    /*}

        .nop-chat-wrapper .open-chat button {
            background: #F5F5F5 url('/Plugins/NopStation.NopChat/Contents/Images/message-icon.png') center no-repeat;
            border: none;
            height: 75px;
            width: 75px;
            border-radius: 1000px;
            font-size: 0;
            box-shadow: 0px 4px 10px rgba(78, 204, 251, 0.25);
        }*/
</style>

<div class="nop-chat-wrapper">
    <div class="nop-chat">
        <div class="title">
            <div class="chat-logo">
                <img id="mainAvater" src="~/Plugins/NopStation.NopChat/Contents/Images/nopchat-logo.png" alt="Nop Chat">
            </div>
        </div>
        <div class="chat-body">
            <div class="contact-list">
                @*<div class="contact unread">
                        <div class="contact-picture">
                            <div class="picture">
                                <img src="~/images/samples/category_apparel.jpeg" />
                            </div>
                        </div>
                        <div class="contact-body">
                            <div class="name">
                                adiba
                            </div>
                            <div class="message-preview">
                                adiba sent you a message
                            </div>
                        </div>
                    </div>*@
            </div>
            <div class="chat-box">
                @*<input type="hidden" id="hdCuctomerId" />*@
                <input type="hidden" id="hdCustomerId" />
                <div class="messages" id="msg_history">

                </div>
                <div class="text-box">
                    <input type="text" id="txtText" placeholder="Write a message..." />
                    <div class="send-button">
                        <button type="button" onclick="SendMessage()">Send</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    @*<div class="open-chat">
            <button type="button">Open Chat</button>
        </div>*@
</div>
<script src="~/Plugins/NopStation.NopChat/Scripts/signalr.js"></script>
<script asp-location="Footer">
    var VendorId = @Model.VendorId;
    var VendorCustomerId = @Model.VendorCustomerId;

    var contactList = JSON.parse('@Html.Raw(Json.Serialize(Model.ContactList))');

    var chatHistoryGlobal = [];
    $(document).ready(function () {

        var connection = new signalR.HubConnectionBuilder()
            .withUrl('/nopChatHub')
            .build();
        connection.serverTimeoutInMilliseconds = 100000; // 100 second

        connection.on('NewMessagesHub', res => {
            console.log(res);
            appenedReceivedMessage(res.message);

        });

        function start() {
            connection.start()
                .then(function () {
                    console.log("Connected");
                    //connection.invoke('setconnection');
                })
                .catch(function (err) {
                    console.log(err);
                    setTimeout(function () {
                        start();
                    }, 10000);
                });
        }

        connection.onclose(function () {
            //start();
            console.log("SignalR connection clossed.");
        });

        start();

        //******************SignalR End************************
        applyOverLayScrollBars();
        renderContactList(contactList);

        $(document).delegate('.contact', 'click', function (e) {
            e.preventDefault();
            var chatHistory;

            customerId = parseInt($(this).attr("data-id"));
            vendorId = @Model.VendorId;

            chatHistory = chatHistoryGlobal["contact_" + customerId];
            activateContact("contact_" + customerId);

            if (chatHistory != null) {
                renderChatBox(chatHistory);
            }
            else {
                GetChatHistory(customerId, vendorId);
            }

            removeNewMessageIndication(customerId);

        });
    });
    function renderContactList(contactList) {
        console.log(contactList);
        var html = '';
        $.each(contactList, function (index, value) {
            html += prepareContactHtml(value);
        });
        $(".contact-list").html(html);
    }
    function prepareContactHtml(value) {
        var html = "";
        html += '<div class="contact" style="cursor: pointer;" id="contact_' + value.Id + '" data-id="' + value.Id + '">';
        html += '<div class="contact-picture">';
        html += '<div class="picture">';
        html += '<img src="/images/samples/category_apparel.jpeg" />';
        html += '</div>';
        html += '</div>';
        html += '<div class="contact-body">';
        html += '<div class="name">' + value.Name + ' <span id="chatNotification_' + value.Id + '"</div>';
        //html += '<div class="message-preview">Lorem Ipsum</div>';
        html += '</div>';
        html += '</div>';

        return html;
    }
    function applyOverLayScrollBars() {
        $('.nop-chat .contact-list').overlayScrollbars({});
        $('.nop-chat .messages').overlayScrollbars({});
    }
    function GetChatHistory(customerId, vendorId) {
            var postData = {
                customerId: customerId,
                vendorId: vendorId
            };
            console.log(postData);

            var postLink = "@(Url.Action("GetChatHistory", "NopChat"))";
        postLink = postLink.replace("/Admin/NopChat/GetChatHistory", "/NopChat/GetChatHistory");

            $.ajax({
            cache: false,
            type: "POST",
            url: postLink,
            data: postData,
            //contentType: 'application/json; charset=utf-8',
            success: function (data) {
                console.log(data);
                renderChatBox(data.Result);
                chatHistoryGlobal["contact_" + customerId] = data.Result;
                //console.log(chatHistoryGlobal);
                $("#hdCustomerId").val(customerId);
                //$("#hdVendorId").val(vendorId);
                updateScroll();
            },
            error: function (request, status, error) {
                console.log(error);
            }
        });
    }
    function renderChatBox(data) {
        var messageListHtml = "";
        $.each(data, function (index, value) {
            if (value.IsVendorResponse == false) {
                messageListHtml += prepareReceivedMessage(value);
            }
            else {
                messageListHtml += prepareSentMessage(value);
            }
        });
        //$(".os-content").html(messageListHtml);
        $("#msg_history .os-content").html(messageListHtml);
    }
    function prepareReceivedMessage(value) {
        var messageListHtml = "";
        messageListHtml += '<div class="message">';
        messageListHtml += '<div class="message-picture">';
        messageListHtml += '<div class="picture">';
        messageListHtml += '<img src="/images/samples/category_apparel_accessories.jpg" />';
        messageListHtml += '</div>';
        messageListHtml += '</div>';
        messageListHtml += '<div class="message-content">';
        messageListHtml += '<div class="text">' + value.Text + '</div>';
        messageListHtml += '<div class="time-stamp">' + value.DateCreated + '</div>';
        messageListHtml += '</div>';
        messageListHtml += '</div>';

        return messageListHtml;
    }
    function prepareSentMessage(value) {
        var messageListHtml = "";

        messageListHtml += '<div class="message self">';
        messageListHtml += '<div class="message-picture">';
        messageListHtml += '<div class="picture">';
        messageListHtml += '<img src="/images/samples/category_apparel_accessories.jpg" />';
        messageListHtml += '</div>';
        messageListHtml += '</div>';
        messageListHtml += '<div class="message-content">';
        messageListHtml += '<div class="text">' + value.Text + '</div>';
        messageListHtml += '<div class="time-stamp">' + value.DateCreated + '</div>';
        messageListHtml += '</div>';
        messageListHtml += '</div>';

        return messageListHtml;
    }
    function SendMessage() {
        var text = $("#txtText").val();
        var ContactId = 0;

        var customerId = $("#hdCustomerId").val();

        var postData = {
            Text: text,
            CustomerId: customerId,
            VendorId: VendorId,
            VendorCustomerId: VendorCustomerId,
            IsVendorResponse: true

        };
        console.log(postData);

        var postLink = "@(Url.Action("SendMessage", "NopChat"))";
        postLink = postLink.replace("/Admin/NopChat/SendMessage", "/NopChat/SendMessage");

        $.ajax({
            cache: false,
            type: "POST",
            url: postLink,
            data: postData,
            success: function (data) {
                console.log(data);
                if (data.Result == true) {
                    $("#txtText").val("");

                    $("#contact_" + customerId).trigger("click");
                }
                else {
                    alert("Message could not be sent!");
                }
            },
            error: function (request, status, error) {
                console.log(error);
            }
        });
    }
    function updateScroll() {
        $('#msg_history').scrollTop($('#msg_history')[0].scrollHeight);
    }
    function activateContact(chat_list_Id) {
        $(".contact").removeClass("active_chat");
        $("#" + chat_list_Id).addClass("active_chat");
    }
    function appenedReceivedMessage(message) {
        var customerId = $("#hdCustomerId").val();
        console.log("c : " + customerId + " & v : " + VendorId);
        var newMessage = {
            Text: message.text,
            DateCreated: message.dateCreated,
            CustomerId: message.customerId,
            CustomerName: message.customerName,
            VendorId: message.vendorId,
            VendorName: message.vendorName,
            IsChecked: message.isChecked,
            IsVendorResponse: message.isVendorResponse
        };

        var ContactId = message.customerId;
        //alert("Vendor : " + vendorId + " == " + message.vendorId);
        if (customerId == message.customerId) {
            var messageListHtml = "";
            if (message.isVendorResponse == true) {
                messageListHtml = prepareSentMessage(newMessage);
            }
            else {
                messageListHtml = prepareReceivedMessage(newMessage);
            }
            $("#msg_history .os-content").append(messageListHtml);
        }

        var isListed = isListedContact(ContactId);
        if (isListed == true) {
            if (chatHistoryGlobal["contact_" + ContactId] != null) {
                chatHistoryGlobal["contact_" + ContactId].push(newMessage);
            }
        }
        else {
            var newContact = {
                Id: ContactId,
                Name: message.customerName,
                LastMesageDate: "",
                NumberOfMessage: 0
            }
            var newMessageList = [];
            newMessageList.push(newMessage);
            chatHistoryGlobal["contact_" + ContactId] = newMessageList;
            contactList.push(newContact);
            renderContactList(contactList);
        }

        indicateNewMessage(ContactId);
    }
    function appenedSentMessage(message) {
        var messageListHtml = prepareSentMessage(message);
        $("#msg_history .os-content").append(messageListHtml);
    }
    function isListedContact(contactId) {
        var id = $("#contact_" + contactId).attr("data-id");
        if (id != null)
            return true;

        return false;
    }
    function indicateNewMessage(ContactId) {

        $("#contact_" + ContactId).addClass('unread');
    }
    function removeNewMessageIndication(ContactId) {
        $("#contact_" + ContactId).removeClass('unread');
    }
</script>
